<!doctype html>
<html>
    <head>
        <title>Index</title>
        <link rel="stylesheet" type="text/css" href="style.css"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script type="text/javascript" src="api.js"></script>
    </head>
    <body>
        <div class="topnav">
            <a href="/" class="title">AhoyDTU</a>
            <a href="javascript:void(0);" class="icon" onclick="topnav()">
                <span></span>
                <span></span>
                <span></span>
            </a>
            <div id="topnav" class="hide"></div>
            <div id="wifiicon" class="info"></div>
        </div>
        <div id="wrapper">
            <div id="content">
                <script>
                    function promptFunction() {
                        var Text = prompt("This project was started from https://www.mikrocontroller.net/topic/525778 this discussion.\n\n" +
                        "The Hoymiles protocol was decrypted through the voluntary efforts of many participants. ahoy, among others, was developed based on this work.\n" +
                        "The software was developed to the best of our knowledge and belief. Nevertheless, no liability can be accepted for a malfunction or guarantee loss of the inverter.\n\n" +
                        "Ahoy is freely available. If you paid money for the software, you probably got ripped off.\n\nPlease type in 'YeS', you are accept our Disclaim. You should then save your config.", "");
                        if (Text != "YeS")
                            promptFunction();
                        else
                            return true;

                    }
                </script>
                <p>
                    <span class="des">Uptime: </span><span id="uptime"></span><br/>
                    <span class="des">ESP-Time: </span><span id="date"></span>
                </p>
                <p>
                    <span class="des">System Infos:</span>
                    <div id="iv"></div>
                    <div class="hr"></div>
                    <div id="warn_info"></div>
                </p>

                <div class="hr"></div>
                <div id="note">
                    <h3>Support this project:</h3>
                    <ul>
                        <li>Discuss with us on <a href="https://discord.gg/WzhxEY62mB">Discord</a></li>
                        <li>Report <a href="https://github.com/lumapu/ahoy/issues" target="_blank">issues</a></li>
                        <li>Contribute to <a href="https://github.com/lumapu/ahoy/blob/main/User_Manual.md"  target="_blank">documentation</a></li>
                        <li>Test <a href="https://github.com/lumapu/ahoy/actions/workflows/compile_development.yml"  target="_blank">development firmware</a></li>
                        <li>make a <a href="https://paypal.me/lupusch"  target="_blank">donation</a></li>
                    </ul>
                    <p class="lic">
                        This project was started from <a href="https://www.mikrocontroller.net/topic/525778" target="_blank">this discussion. (Mikrocontroller.net)</a>
                    </p>
                </div>
            </div>
        </div>
        <div id="footer">
            <div class="left">
                <a href="https://ahoydtu.de" target="_blank">AhoyDTU &copy 2022</a>
                <ul>
                    <li><a href="https://discord.gg/WzhxEY62mB" target="_blank">Discord</a></li>
                    <li><a href="https://github.com/lumapu/ahoy" target="_blank">Github</a></li>
                </ul>
            </div>
            <div class="right">
                <ul>
                    <li><span id="version"></span></li>
                    <li><span id="esp_type"></span></li>
                    <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/de" target="_blank" >CC BY-NC-SA 3.0</a></li>
                </ul>
            </div>
        </div>
        <script type="text/javascript">
            var exeOnce = true;
            var tickCnt = 0;
            var ts = 0;
            var commInfo = "";

            function apiCb(obj) {
                var e = document.getElementById("apiResult");
                if(obj["success"]) {
                    e.innerHTML = " command excuted";
                    getAjax("/api/index", parse);
                }
                else
                    e.innerHTML = " Error: " + obj["error"];
            }

            function setTime() {
                var date = new Date();
                var obj = new Object();
                obj.cmd = "set_time";
                obj.val = parseInt(date.getTime() / 1000);
                getAjax("/api/setup", apiCb, "POST", JSON.stringify(obj));
            }

            function ts2Span(ts) {
                return span(new Date(ts * 1000).toLocaleString('de-DE'));
            }

            function parseGeneric(obj) {
                // Disclaimer
                //if(obj["disclaimer"] == false) sessionStorage.setItem("gDisclaimer", promptFunction());
                if(exeOnce){
                    parseVersion(obj);
                    parseESP(obj);
                }
                parseRssi(obj);
            }

            function parseSys(obj) {
                ts = obj["ts_now"];
                var date = new Date(obj["ts_now"] * 1000);
                var up = obj["generic"]["ts_uptime"];
                var days = parseInt(up / 86400) % 365;
                var hrs  = parseInt(up / 3600) % 24;
                var min  = parseInt(up / 60) % 60;
                var sec  = up % 60;
                var e = document.getElementById("uptime");
                e.innerHTML = days + " Day";
                if(1 != days)
                    e.innerHTML += "s";
                e.innerHTML += ", " + ("0"+hrs).substr(-2) + ":"
                   + ("0"+min).substr(-2) + ":"
                   + ("0"+sec).substr(-2);
                var dSpan = document.getElementById("date");
                if(0 != obj["ts_now"])
                    dSpan.innerHTML = date.toLocaleString('de-DE');
                else {
                    dSpan.innerHTML = "";
                    var e = inp("set", "sync from browser", 0, ["btn"], "set", "button");
                    dSpan.appendChild(span("NTP timeserver unreachable. "));
                    dSpan.appendChild(e);
                    dSpan.appendChild(span("", ["span"], "apiResult"));
                    e.addEventListener("click", setTime);
                }

                if(obj["ts_sunrise"] > 0) {
                    if(((obj["ts_sunrise"] - obj["ts_offset"]) < obj["ts_now"])
                        && ((obj["ts_sunset"] + obj["ts_offset"]) > obj["ts_now"])) {
                        commInfo = "Polling inverter(s), will stop at " + (new Date((obj["ts_sunset"] + obj["ts_offset"]) * 1000).toLocaleString('de-DE'));
                    }
                    else {
                        commInfo = "Night time, no Communication to Inverter, ";
                        if(obj["ts_now"] > (obj["ts_sunrise"] - obj["ts_offset"])) {
                            commInfo += "stopped polling at " + (new Date((obj["ts_sunset"] + obj["ts_offset"]) * 1000).toLocaleString('de-DE'));
                        }
                        else {
                            commInfo += "will start polling at " + (new Date((obj["ts_sunrise"] - obj["ts_offset"]) * 1000).toLocaleString('de-DE'));
                        }
                    }
                }
            }

            function parseIv(obj) {
                var p = div(["none"]);
                for(var i of obj) {
                    var icon = iconWarn;
                    var color = "#F70";
                    avail = "";
                    if(false == i["enabled"]) {
                        avail = "disabled";
                    }
                    else if(false == i["is_avail"]) {
                        icon = iconInfo;
                        color = "#00d";
                        avail = "not yet available";
                    }
                    else {
                        icon = iconSuccess;
                        avail = "available and is ";
                        if(false == i["is_producing"])
                            avail += "not ";
                        avail += "producing";
                    }

                    p.append(
                        svg(icon, 20, 20, color, "icon"),
                        span("Inverter #" + i["id"] + ": " + i["name"] + " (v" + i["version"] + ") is " + avail),
                        br()
                    );

                    if(false == i["is_avail"]) {
                        if(i["ts_last_success"] > 0) {
                            var date = new Date(i["ts_last_success"] * 1000);
                            p.append(span("-> last successful transmission: " + date.toLocaleString('de-DE')), br());
                        }
                    }
                }
                document.getElementById("iv").replaceChildren(p);
            }

            function parseWarnInfo(warn, success) {
                var p = div(["none"]);
                for(var w of warn) {
                    p.append(svg(iconWarn, 20, 20, "#F70", "icon"), span(w), br());
                }
                for(var i of success) {
                    p.append(svg(iconSuccess, 20, 20, "#090", "icon"), span(i), br());
                }

                if(commInfo.length > 0)
                    p.append(svg(iconInfo, 20, 20, "#00d", "icon"), span(commInfo), br());
                document.getElementById("warn_info").replaceChildren(p);
            }

            function tick() {
                if(0 != ts)
                    document.getElementById("date").innerHTML = (new Date((++ts) * 1000)).toLocaleString('de-DE');
                if(++tickCnt >= 10) {
                    tickCnt = 0;
                    getAjax('/api/index', parse);
                }
            }

            function parse(obj) {
                if(null != obj) {
                    if(exeOnce)
                        parseMenu(obj["menu"]);
                    parseGeneric(obj["generic"]);
                    parseSys(obj);
                    parseIv(obj["inverter"]);
                    parseWarnInfo(obj["warnings"], obj["infos"]);
                    if(exeOnce) {
                        window.setInterval("tick()", 1000);
                        exeOnce = false;
                    }
                }
            }

            getAjax("/api/index", parse);
        </script>
    </body>
</html>
